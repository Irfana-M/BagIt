<%-include("../../views/partials/user/header")%>
<link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
    />

    <style>
      .cart_area {
        padding: 50px 0;
        background-color: #f8f9fa;
      }

      .table {
        background: #fff;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      .table th {
        background: #343a40;
        color: #fff;
        text-transform: uppercase;
        padding: 15px;
        text-align: center;
      }

      .table td {
        padding: 15px;
        vertical-align: middle;
        text-align: center;
      }

      .cartImg {
        width: 80px;
        height: auto;
        border-radius: 8px;
      }

      .product_count {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .product_count input {
        width: 50px;
        text-align: center;
        font-size: 16px;
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }

      .product_count button {
        background: #007bff;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        margin: 0 5px;
        cursor: pointer;
      }

      .product_count button:hover {
        background: #0056b3;
      }

      .remove-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 7px 12px;
        border-radius: 5px;
        font-size: 14px;
        cursor: pointer;
      }

      .remove-btn:hover {
        background: #a71d2a;
      }

      /* Coupon Section */
      .coupon-section {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      .coupon-section input {
        padding: 8px;
        width: 250px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }

      .coupon-section button {
        background: #28a745;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      .coupon-section button:hover {
        background: #218838;
      }

      /* Price Details */
      .price-details {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      .price-details ul {
        list-style: none;
        padding: 0;
      }

      .price-details ul li {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        font-size: 16px;
      }

      .price-details ul li h5 {
        font-weight: bold;
        color: #007bff;
      }

      .final-total {
        font-size: 22px;
        font-weight: bold;
        color: #28a745;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .table th,
        .table td {
          font-size: 14px;
          padding: 10px;
        }

        .cartImg {
          width: 60px;
        }

        .coupon-section input {
          width: 100%;
        }

        .coupon-section button {
          width: 100%;
          margin-top: 10px;
        }
      }
      .cartImg {
        border-radius: 8px;
        border: 1px solid #ddd;
      }

      .card {
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .list-group-item {
        border: none;
        padding: 0.75rem 0;
      }

      .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
      }

      .btn-primary:hover {
        background-color: #0056b3;
        border-color: #004085;
      }

      .btn-outline-secondary {
        border-color: #ddd;
      }

      .btn-outline-secondary:hover {
        background-color: #f8f9fa;
      }
    </style>

    <!-- Start Banner Area -->
    <section class="banner-area organic-breadcrumb">
      <div class="container">
        <div
          class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end"
        >
          <div class="col-first">
            <h1>Shopping Cart</h1>
            <nav class="d-flex align-items-center">
              <a href="/"
                >Home<span class="lnr lnr-arrow-right"></span
              ></a>
              <a href="/shop"
                >Shop<span class="lnr lnr-arrow-right"></span
              ></a>
              <a href="#">Cart</a>
            </nav>
          </div>
        </div>
      </div>
    </section>
    <!-- End Banner Area -->

    <!--================Cart Area =================-->
   <!--================Cart Area =================-->
   <section class="cart_area py-5">
    <div class="container">
      <div class="cart_inner bg-white p-4 rounded shadow-sm">
        <% if (cart && cart.length > 0) { %>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th scope="col">Product</th>
                <th scope="col">Product Name</th>
                <th scope="col">Price</th>
                <th scope="col">Quantity</th>
                <th scope="col">Total</th>
                <th scope="col">Action</th>
              </tr>
            </thead>
            <tbody>
              <% cart.forEach((item) => { %> <% if (item.productId &&
              item.productId.productName && item.productId.productImage) { %>
              <tr>
                <td>
                  <div class="d-flex align-items-center">
                    <img
                      class="cartImg me-3"
                      src="/uploads/product-images/<%= item.productId.productImage[0] %>"
                      alt="<%= item.productId.productName %>"
                      style="width: 80px; height: 80px; object-fit: cover"
                    />
                  </div>
                </td>
                <td>
                  <h5 class="mb-0"><%= item.productId.productName %></h5>
                </td>
                <td>
                  <h5 class="mb-0">
                    <span style="text-decoration: line-through; color: grey">
                      ₹<%= item.productId.regularPrice %>
                    </span>
                    <span
                      style="color: red; font-weight: bold; margin-left: 5px"
                    >
                      ₹<%= item.productId.salePrice %>
                    </span>
                  </h5>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <button
                      onclick="decreaseQuantity('<%= item.productId._id %>', '<%= item.quantity %>', '<%= item.productId.salePrice %>')"
                      class="btn btn-sm btn-outline-secondary"
                    >
                      <i class="bi bi-dash"></i>
                    </button>
                    <input
                      type="text"
                      name="qty"
                      id="sst-<%= item.productId._id %>"
                      value="<%= item.quantity %>"
                      class="form-control form-control-sm mx-2 text-center"
                      style="width: 50px"
                      readonly
                    />
                    <button
                      onclick="increaseQuantity('<%= item.productId._id %>', '<%= item.productId.quantity %>', '<%= item.productId.salePrice %>')"
                      class="btn btn-sm btn-outline-secondary"
                    >
                      <i class="bi bi-plus"></i>
                    </button>
                  </div>
                </td>
                <td>
                  <h5 class="mb-0" id="total-price-<%= item.productId._id %>">
                    ₹<%= item.totalPrice %>
                  </h5>
                </td>
                <td>
                  <a
                    href="/deleteCart?id=<%= item.productId._id %>"
                    onclick="return confirm('Are you sure you want to delete this item?')"
                    class="btn btn-sm btn-danger"
                  >
                    <i class="bi bi-trash"></i>
                  </a>
                  <a id="buy-now-<%= item.productId._id %>" href="/getCheckout?id=<%= item.productId._id %>&quantity=<%= item.quantity %>"
                    class="btn btn-sm btn-success">
                    Buy This Now
                  </a>
                </td>
              </tr>
              <% } %> <% }) %>
            </tbody>
          </table>
        </div>

        <!-- Price Details Section -->
        <div class="col-md-4">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Price Details</h5>
              <ul class="list-group list-group-flush">
                <li
                  class="list-group-item d-flex justify-content-between align-items-center"
                >
                  Total Price
                  <h5 class="mb-0">
                    <span
                      id="totalRegularPrice"
                      style="color: gray; text-decoration: line-through"
                      >₹<%= totalPriceWithoutOffer.toLocaleString('en-IN')
                      %></span
                    >
                    <span
                      id="totalSalePrice"
                      style="color: red; font-weight: bold"
                      >₹<%= finalTotal.toLocaleString('en-IN') %></span
                    >
                  </h5>
                </li>

                <li
                  class="list-group-item d-flex justify-content-between align-items-center"
                >
                  Discount
                  <span
                    id="totalDiscount"
                    style="color: green; font-weight: bold"
                    >-₹<%= totalDiscount.toLocaleString('en-IN') %></span
                  >
                </li>
                <li
                  class="list-group-item d-flex justify-content-between align-items-center fw-bold"
                >
                  Total Amount
                  <span id="final-total"
                    >₹<%= finalTotal.toLocaleString('en-IN') %></span
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Continue Shopping and Checkout Buttons -->
        <div class="d-flex justify-content-between mt-4">
          <a href="/shop" class="btn btn-outline-secondary"
            >Continue Shopping</a
          >
          <a href="/checkout" class="btn btn-primary">Place Order</a>
        </div>

        <% } else { %>
        <div class="text-center py-5">
          <h3>Your cart is empty</h3>
          <p class="mb-4">
            Looks like you haven't added anything to your cart yet.
          </p>
          <a href="/shop" class="btn btn-primary">Continue Shopping</a>
        </div>
        <% } %>
      </div>
    </div>
  </section>

  <% if (cart && cart.length > 0) { %>
  <div class="pagination">
    <% if (currentPage > 1) { %>
    <a href="?page=<%= currentPage - 1 %>">Previous</a>
    <% } %>
    <span>Page <%= currentPage %> of <%= totalPages %></span>
    <% if (currentPage < totalPages) { %>
    <a href="?page=<%= currentPage + 1 %>">Next</a>
    <% } %>
  </div>
  <% } else { %>
  <p>Your cart is empty.</p>
  <% } %>

    <!--================End Cart Area =================-->

    <script src="js/vendor/jquery-2.2.4.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"
      integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4"
      crossorigin="anonymous"
    ></script>
    <script src="js/vendor/bootstrap.min.js"></script>
    <script src="js/jquery.ajaxchimp.min.js"></script>
    <script src="js/jquery.nice-select.min.js"></script>
    <script src="js/jquery.sticky.js"></script>
    <script src="js/nouislider.min.js"></script>
    <script src="js/jquery.magnific-popup.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <!--gmaps Js-->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCjCGmQ0Uq4exrzdcL6rvxywDDOvfAu6eE"></script>
    <script src="js/gmaps.min.js"></script>
    <script src="js/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
     function increaseQuantity(productId, stock, salePrice) {
        const quantityField = document.getElementById(`sst-${productId}`);
        const totalPriceField = document.getElementById(
          `total-price-${productId}`
        );

        let currentQuantity = parseInt(quantityField.value);

        if (currentQuantity < stock) {
          currentQuantity++;
          quantityField.value = currentQuantity;

          totalPriceField.textContent = `₹${(
            currentQuantity * salePrice
          ).toLocaleString("en-IN")}`;

          updateCart(productId, currentQuantity);
        } else {
          Swal.fire({
            icon: "warning",
            title: "Out of Stock",
            text: "Sorry, we've run out of stock for this product.",
            confirmButtonText: "OK",
          });

          // Optional: Disable the plus button if stock is 0
          document.getElementById(`increase-btn-${productId}`).disabled = true;
        }
      }

      function decreaseQuantity(productId, stock, salePrice) {
        const quantityField = document.getElementById(`sst-${productId}`);
        const totalPriceField = document.getElementById(
          `total-price-${productId}`
        );

        let currentQuantity = parseInt(quantityField.value);

        if (currentQuantity > 1) {
          currentQuantity--;
          quantityField.value = currentQuantity;

          totalPriceField.textContent = `₹${(
            currentQuantity * salePrice
          ).toLocaleString("en-IN")}`;

          updateCart(productId, currentQuantity);
        }
      }

      function updateCart(productId, newQuantity) {
  fetch("/update-cart", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      productId: productId,
      quantity: newQuantity,
    }),
  })
    .then((response) => response.json())
    .then((data) => {
      if (data.success) {
        // Update the total price dynamically
        const totalPriceElement = document.getElementById(
          `total-price-${productId}`
        );
        if (totalPriceElement) {
          totalPriceElement.innerText = `₹${data.newTotalPrice}`;
        }

        // Update final total if the element exists
        const finalTotalElement = document.getElementById("final-total");
        const totalSalePrice = document.getElementById("totalSalePrice");
        const totalRegularPrice = document.getElementById("totalRegularPrice");
        const totalDiscount = document.getElementById("totalDiscount");

        if (finalTotalElement) {
          finalTotalElement.innerText = `₹${data.finalTotal}`;
        }
        if (totalSalePrice) {
          totalSalePrice.innerText = `₹${data.finalTotal}`;
        }
        if (totalRegularPrice) {
          totalRegularPrice.innerText = `₹${data.totalOriginalPrice}`;
        }
        if (totalDiscount) {
          totalDiscount.innerText = `-₹${data.totalDiscount}`;
        }

        // 🔥 Update the "Buy This Now" link with the new quantity
        const buyNowLink = document.getElementById(`buy-now-${productId}`);
        if (buyNowLink) {
          buyNowLink.href = `/getCheckout?id=${productId}&quantity=${newQuantity}`;
        }

        console.log("Cart updated successfully");
      } else {
        Swal.fire({
          icon: "error",
          title: "Failed to update cart",
          text: data.message || "Something went wrong while updating the cart.",
          confirmButtonText: "OK",
        });
      }
    })
    .catch((error) => {
      console.error("Error updating cart:", error);
      Swal.fire({
        icon: "error",
        title: "Network Error",
        text: "Failed to connect to the server. Please try again later.",
        confirmButtonText: "OK",
      });
    });
}
    </script>
    <script>
      document.querySelectorAll(".remove-btn").forEach((button) => {
        button.addEventListener("click", function () {
          this.closest(".address-card").remove();
        });
      });
    </script>
  </body>
</html>
