<!DOCTYPE html>
<html lang="zxx" class="no-js">
  <head>
    <!-- Mobile Specific Meta -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <!-- Favicon-->
    <link rel="shortcut icon" href="img/logo.png" />
    <!-- Author Meta -->
    <meta name="author" content="CodePixar" />
    <!-- Meta Description -->
    <meta name="description" content="" />
    <!-- Meta Keyword -->
    <meta name="keywords" content="" />
    <!-- meta character set -->
    <meta charset="UTF-8" />
    <!-- Site Title -->
    <title>BAG IT Shopping - Checkout</title>

    <!-- CSS -->
    <link rel="stylesheet" href="css/linearicons.css" />
    <link rel="stylesheet" href="css/owl.carousel.css" />
    <link rel="stylesheet" href="css/themify-icons.css" />
    <link rel="stylesheet" href="css/font-awesome.min.css" />
    <link rel="stylesheet" href="css/nice-select.css" />
    <link rel="stylesheet" href="css/nouislider.min.css" />
    <link rel="stylesheet" href="css/bootstrap.css" />
    <link rel="stylesheet" href="css/main.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <style>
      /* General Reset */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        line-height: 1.6;
        color: #333;
        background-color: #f8f9fa;
      }

      /* Checkout Area */
      .checkout_area {
        padding: 50px 0;
      }

      .select_address {
        background: #fff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .select_address h3 {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 20px;
        color: #333;
      }

      .select_address .form-group {
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        transition: all 0.3s ease;
      }

      .select_address .form-group:hover {
        border-color: #00bcd4;
        box-shadow: 0 2px 10px rgba(0, 188, 212, 0.1);
      }

      .select_address input[type="radio"] {
        margin-right: 10px;
      }

      .select_address label {
        font-size: 16px;
        color: #333;
        cursor: pointer;
      }

      .select_address a {
        color: #00bcd4;
        text-decoration: none;
        font-weight: bold;
      }

      .select_address a:hover {
        text-decoration: underline;
      }

      /* Order Summary */
      .order_box {
        background: #fff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .order_box h2 {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 20px;
        color: #333;
      }

      .order_box .list {
        list-style: none;
        padding: 0;
        margin-bottom: 20px;
      }

      .order_box .list li {
        font-size: 16px;
        margin-bottom: 10px;
        color: #333;
      }

      .order_box .list .last {
        font-weight: bold;
        color: #00bcd4;
      }

      .order_box .payment_item {
        margin-bottom: 15px;
      }

      .order_box .payment_item label {
        font-size: 16px;
        color: #333;
      }

      .order_box .payment_item label i {
        margin-right: 10px;
      }

      .order_box .primary-btn {
        background: #00bcd4;
        color: #fff;
        border: none;
        padding: 12px 25px;
        border-radius: 5px;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.3s;
        width: 100%;
      }

      .order_box .primary-btn:hover {
        background: #0097a7;
      }

      /* Footer Styling */
      .footer-area {
        background: #222;
        color: #fff;
        padding: 30px 0;
      }

      .footer-area h6 {
        font-size: 20px;
        font-weight: bold;
        color: #00bcd4;
        margin-bottom: 20px;
      }

      .footer-area p {
        font-size: 16px;
        color: #bbb;
      }

      .footer-area a {
        color: #fff;
        text-decoration: none;
      }

      .footer-area a:hover {
        text-decoration: underline;
      }
    </style>
  </head>

  <body>
    <!-- Start Header Area -->
    <header class="header_area sticky-header">
      <div class="main_menu">
        <nav class="navbar navbar-expand-lg navbar-light main_box">
          <div class="container">
            <a class="navbar-brand logo_h" href="/"
              ><img src="img/logo.png" alt=""
            /></a>
            <button
              class="navbar-toggler"
              type="button"
              data-toggle="collapse"
              data-target="#navbarSupportedContent"
              aria-controls="navbarSupportedContent"
              aria-expanded="false"
              aria-label="Toggle navigation"
            >
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <div
              class="collapse navbar-collapse offset"
              id="navbarSupportedContent"
            >
              <ul class="nav navbar-nav menu_nav ml-auto">
                <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                <li class="nav-item active">
                  <a class="nav-link" href="/shop">Shop</a>
                </li>
              </ul>
              <ul class="nav navbar-nav navbar-right">
                <li class="nav-item">
                  <a href="/view-cart" class="cart"
                    ><span class="ti-bag"></span
                  ></a>
                </li>
              </ul>
            </div>
          </div>
        </nav>
      </div>
    </header>
    <!-- End Header Area -->

    <!-- Start Banner Area -->
    <section class="banner-area organic-breadcrumb">
      <div class="container">
        <div
          class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end"
        >
          <div class="col-first">
            <h1>Checkout</h1>
            <nav class="d-flex align-items-center">
              <a href="/">Home<span class="lnr lnr-arrow-right"></span></a>
              <a href="/checkout">Checkout</a>
            </nav>
          </div>
        </div>
      </div>
    </section>
    <!-- End Banner Area -->

    <!--================Checkout Area =================-->
    <section class="checkout_area section_gap">
      <div class="container">
        <div class="row">
          <!-- Select Address Section -->
          <div class="col-md-8">
            <div class="select_address">
              <h3>Select Address</h3>
              <% if (addresses.address && addresses.address.length > 0) { %> <%
              addresses.address.forEach(address => { %>
              <div class="form-group">
                <input
                  type="radio"
                  name="addressId"
                  value="<%= address._id %>"
                  id="address_<%= address._id %>"
                  required
                />
                <label for="address_<%= address._id %>">
                  <strong><%= address.addressType %></strong><br />
                  <%= address.city %>, <%= address.landMark %><br />
                  <%= address.state %>, <%= address.pincode %><br />
                  Phone: <%= address.phone %><br />
                  Alternate Phone: <%= address.altPhone %>
                </label>
              </div>
              <% }); %>
              <div>
                <a href="/add-address?redirectTo=checkout">Add New Address</a>
              </div>
              <% } else { %>
              <p>
                <a href="/add-address?redirectTo=checkout"
                  >No saved addresses. Please add one.</a
                >
              </p>
              <% } %>
            </div>
          </div>

          <!-- Order Summary Section -->
          <div id="couponPopup" class="modal fade" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Available Coupons</h5>
                  <button
                    type="button"
                    class="close"
                    data-dismiss="modal"
                    aria-label="Close"
                  >
                    <span>&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <% if (coupons.length > 0) { %>
                  <ul>
                    <% coupons.forEach(coupon => { %>
                    <li>
                      <strong style="color: #0097a7"><%= coupon.name %></strong>
                      - ₹<%= coupon.offerPrice %> Off (Min Purchase: ₹<%=
                      coupon.minimumPrice %>)
                    </li>
                    <% }); %>
                  </ul>
                  <% } else { %>
                  <p>No coupons available.</p>
                  <% } %>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="order_box">
              <h2>Your Order</h2>
              <% if (cart && cart.items && cart.items.length > 0) { %>
              <ul class="list">
                <li>
                  <a href="#">Product <span>Total</span></a>
                </li>
                <% cart.items.forEach(item => { %>
                <li>
                  <a href="#"
                    ><%= item.productId.productName %> x <%= item.quantity %>
                    <span class="last"
                      >₹<%= (item.productId.salePrice *
                      item.quantity).toFixed(2) %></span
                    ></a
                  >
                </li>
                <% }); %>
              </ul>
              <ul class="list list_2">
                <li>
                  <a href="#"
                    >Subtotal
                    <span id="subTotal">₹<%= totalOriginalPrice %></span></a
                  >
                </li>
                <li>
                  <a href="#">Shipping <span>₹<%= shippingCharge %></span></a>
                </li>
                <li>
                  <a href="#"
                    >Discount
                    <span id="productOffer"
                      >-₹<%= totalProductOffer || 0 %></span
                    ></a
                  >
                </li>
                <li>
                  <a href="#"
                    >Coupon Discount
                    <span id="couponDiscount"
                      >-₹<%= couponDiscount || 0 %></span
                    ></a
                  >
                </li>

                <% let gst = (typeof subTotal !== 'undefined' ? (subTotal * 0.05).toFixed(2) : "0.00"); %>

                <li>
                  <a href="#">GST (5%) <span>₹<%= gst %></span></a>
                </li>

                <% if (coupons && coupons.length > 0) { %>
                <li>
                  <button
                    type="button"
                    class="btn btn-info btn-sm"
                    data-toggle="modal"
                    data-target="#couponPopup"
                  >
                    View Coupons
                  </button>
                </li>
                <li>
                  <input
                    type="text"
                    id="couponCode"
                    class="form-control mt-2"
                    placeholder="Enter Coupon Code"
                  />
                  <button id="applyCoupon" class="btn btn-success btn-sm mt-2">
                    Apply
                  </button>
                </li>
                <% } %> <% if (cart.appliedCoupon) { %>
                <li>
                  <a href="#"
                    >Discount (<%= cart.appliedCoupon.name %>)
                    <span id="couponDiscount"
                      >-₹<%= cart.appliedCoupon.discount %></span
                    ></a
                  >
                </li>
                <button
                  id="removeCoupon"
                  class="btn btn-danger btn-sm mt-2"
                  style="display: block"
                >
                  Remove Coupon
                </button>
                <% } else { %>
                <button
                  id="removeCoupon"
                  class="btn btn-danger btn-sm mt-2"
                  style="display: none"
                >
                  Remove Coupon
                </button>
                <% } %> <% if (typeof subTotal !== 'undefined') { %>
                <li>
                  <a href="#"
                    >Total <span id="finalTotal">₹<%= finalTotal %></span></a
                  >
                </li>
                <% } %>
              </ul>

              <% } else { %>
              <p>Your cart is empty</p>
              <% } %>

              <h3><u>Payments</u></h3>
              <div class="payment_item active">
                <div class="radion_btn">
                  <input
                    type="radio"
                    id="f-option6"
                    name="paymentMethod"
                    value="Cash on Delivery"
                  />
                  <label for="f-option6"
                    ><i class="bi bi-cash"></i>Cash on Delivery</label
                  >
                  <div class="check"></div>
                </div>
              </div>
              <div class="payment_item active">
                <div class="radion_btn">
                  <input
                    type="radio"
                    id="f-option7"
                    name="paymentMethod"
                    value="Credit/Debit Card"
                  />
                  <label for="f-option7"
                    ><i class="bi bi-credit-card"></i>Credit/Debit/ATM
                    Card</label
                  >
                  <div class="check"></div>
                </div>
              </div>
              <div class="payment_item active">
                <div class="radion_btn">
                  <input
                    type="radio"
                    id="f-option8"
                    name="paymentMethod"
                    value="razorPay"
                  />
                  <label for="f-option8"
                    ><i class="bi bi-bank"></i>Razorpay</label
                  >
                  <div class="check"></div>
                </div>
              </div>
              <div class="payment_item active">
                <div class="radion_btn">
                  <input
                    type="radio"
                    id="f-option9"
                    name="paymentMethod"
                    value="Wallets"
                  />
                  <label for="f-option9"
                    ><i class="bi bi-wallet2"></i>Wallets</label
                  >
                  <div class="check"></div>
                </div>
              </div>

              <a id="checkout-link" class="primary-btn" onclick="updateCheckoutLink()">Checkout</a>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!--================End Checkout Area =================-->

    <!-- Start Footer Area -->
    <footer class="footer-area section_gap">
      <div class="container">
        <div class="row">
          <div class="col-lg-3 col-md-6 col-sm-6">
            <div class="single-footer-widget">
              <h6>About Us</h6>
              <p>
                Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do
                eiusmod tempor incididunt ut labore dolore magna aliqua.
              </p>
            </div>
          </div>
          <div class="col-lg-4 col-md-6 col-sm-6">
            <div class="single-footer-widget">
              <h6>Newsletter</h6>
              <p>Stay update with our latest</p>
              <form
                target="_blank"
                novalidate="true"
                action="https://spondonit.us12.list-manage.com/subscribe/post?u=1462626880ade1ac87bd9c93a&amp;id=92a4423d01"
                method="get"
                class="form-inline"
              >
                <input
                  class="form-control"
                  name="EMAIL"
                  placeholder="Enter Email"
                  required=""
                  type="email"
                />
                <button class="click-btn btn btn-default">
                  <i class="fa fa-long-arrow-right" aria-hidden="true"></i>
                </button>
              </form>
            </div>
          </div>
          <div class="col-lg-3 col-md-6 col-sm-6">
            <div class="single-footer-widget">
              <h6>Follow Us</h6>
              <p>Let us be social</p>
              <div class="footer-social d-flex align-items-center">
                <a href="#"><i class="fa fa-facebook"></i></a>
                <a href="#"><i class="fa fa-twitter"></i></a>
                <a href="#"><i class="fa fa-dribbble"></i></a>
                <a href="#"><i class="fa fa-behance"></i></a>
              </div>
            </div>
          </div>
        </div>
        <div
          class="footer-bottom d-flex justify-content-center align-items-center flex-wrap"
        >
          <p class="footer-text m-0">
            Copyright &copy;
            <script>
              document.write(new Date().getFullYear());
            </script>
            All rights reserved | This template is made with
            <i class="fa fa-heart-o" aria-hidden="true"></i> by
            <a href="https://colorlib.com" target="_blank">Colorlib</a>
          </p>
        </div>
      </div>
    </footer>
    <!-- End Footer Area -->

    <script src="js/vendor/jquery-2.2.4.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"
      integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4"
      crossorigin="anonymous"
    ></script>
    <script src="js/vendor/bootstrap.min.js"></script>
    <script src="js/jquery.ajaxchimp.min.js"></script>
    <script src="js/jquery.nice-select.min.js"></script>
    <script src="js/jquery.sticky.js"></script>
    <script src="js/nouislider.min.js"></script>
    <script src="js/jquery.magnific-popup.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/main.js"></script>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function showAlert(type, title, text) {
            Swal.fire({
                icon: type, // "success", "error", "warning", "info"
                title: title,
                text: text,
                confirmButtonColor: type === "success" ? "#28a745" : "#d33",
            });
        }
    
        // Parse cart data from server
        const cart = JSON.parse('<%- JSON.stringify(cart || []) %>');
        const cartItems = encodeURIComponent(JSON.stringify(cart.items || []));
    
        function updateCheckoutLink() {
            const selectedPayment = document.querySelector('input[name="paymentMethod"]:checked');
            const selectedAddress = document.querySelector('input[name="addressId"]:checked');
    
            if (!selectedPayment) {
                showAlert("warning", "Payment Method Required", "Please select a payment method before proceeding.");
                return;
            }
    
            if (!selectedAddress) {
                showAlert("warning", "Address Required", "Please select an address before proceeding.");
                return;
            }
    
            const addressId = selectedAddress.value;
            const totalPrice = "<%= subTotal %>";
            const paymentMethod = selectedPayment.value;
    
            console.log("Selected Payment Method:", paymentMethod);
            console.log("Total Price:", totalPrice);
            console.log("Cart Items:", cartItems);
    
            switch (paymentMethod) {
                case "razorPay":
                    if (typeof handleRazorpayPayment === "function") {
                        handleRazorpayPayment(totalPrice, addressId, cartItems);
                    } else {
                        console.error("handleRazorpayPayment function is not defined");
                    }
                    break;
    
                case "Wallets":
                    if (typeof handleWalletPayment === "function") {
                        handleWalletPayment(totalPrice, addressId, cartItems);
                    } else {
                        console.error("handleWalletPayment function is not defined");
                    }
                    break;
    
                case "Cash on Delivery":
                    if (typeof handleCashOnDelivery === "function") {
                        handleCashOnDelivery(totalPrice, addressId, cartItems);
                    } else {
                        console.error("handleCashOnDelivery function is not defined");
                    }
                    break;
    
                default:
                    showAlert("error", "Invalid Payment Method", "Please select a valid payment method.");
            }
        }
    
        function handleRazorpayPayment(amount, addressId, cartItems) {
    fetch("/razorpay-payment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ totalPrice: amount }),
    })
        .then((res) => res.json())
        .then((data) => {
            if (data.success) {
                const options = {
                    key: "<%= razorpayKey %>",
                    amount: amount * 100,
                    currency: "INR",
                    name: "Your Shop Name",
                    description: "Order Payment",
                    order_id: data.order.id,
                    handler: function (response) {
                        fetch("/razorpay-verify", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                razorpay_payment_id: response.razorpay_payment_id,
                                razorpay_order_id: response.razorpay_order_id,
                                razorpay_signature: response.razorpay_signature,
                                addressId,
                                totalPrice: amount,
                                cartItems,
                            }),
                        })
                            .then((res) => res.json())
                            .then((data) => {
                                if (data.success) {
                                    window.location.href = `/confirmation?cartItems=${encodeURIComponent(JSON.stringify(cartItems))}&totalPrice=${amount}&addressId=${addressId}`;
                                } else {
                                    alert("Payment verification failed!");
                                }
                            });
                    },
                };
                const rzp1 = new Razorpay(options);
                rzp1.open();
            } else {
                alert("Failed to create Razorpay order!");
            }
        })
        .catch((err) => {
            console.error(err);
            alert("Something went wrong. Please try again later.");
        });
}



function handleCashOnDelivery(amount, addressId, cartItems) {
    if (!amount || !addressId || !cartItems || cartItems.length === 0) {
        alert("Invalid order details. Please check your cart and address.");
        return;
    }

    fetch("/cod-payment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ addressId, totalPrice: amount, cartItems }),
    })
    .then((res) => {
        if (!res.ok) {
            throw new Error(`HTTP error! Status: ${res.status}`);
        }
        return res.json();
    })
    .then((data) => {
        if (data.success) {
            // Redirect to the confirmation page with query parameters
            window.location.href = `/confirmation?cartItems=${encodeURIComponent(JSON.stringify(cartItems))}&totalPrice=${amount}&addressId=${addressId}&paymentMethod=Cash on Delivery`;
        } else {
            alert(data.message || "Failed to place COD order.");
        }
    })
    .catch((err) => {
        console.error("COD Payment Error:", err);
        alert("Something went wrong. Please try again later.");
    });
}




function handleWalletPayment(amount, addressId, cartItems) {
    fetch("/wallet-payment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ addressId, totalPrice: amount, cartItems }),
    })
        .then((res) => res.json())
        .then((data) => {
            if (data.success) {
                window.location.href = `/confirmation?cartItems=${encodeURIComponent(JSON.stringify(cartItems))}&totalPrice=${amount}&addressId=${addressId}`;
            } else {
                alert(data.message || "Failed to place order using Wallet.");
            }
        })
        .catch((err) => {
            console.error(err);
            alert("Something went wrong. Please try again later.");
        });
}
    </script>
    
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const applyCouponBtn = document.getElementById("applyCoupon");
        const removeCouponBtn = document.getElementById("removeCoupon");
        const couponCodeInput = document.getElementById("couponCode");
        const discount = document.getElementById("productOffer");
        const couponDiscountField = document.getElementById("couponDiscount");
        const finalTotalField = document.getElementById("finalTotal");
        const subTotalField = document.getElementById("subTotal");

        if (applyCouponBtn) {
          applyCouponBtn.addEventListener("click", async () => {
            let couponCode = couponCodeInput.value.trim();
            if (!couponCode) {
              Swal.fire({
                title: "Oops!",
                text: "Please enter a coupon code!",
                icon: "warning",
              });
              return;
            }

            try {
              const response = await fetch("/apply-coupon", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ couponCode }),
              });

              const data = await response.json();

              if (data.success) {
                Swal.fire({
                  title: "Success!",
                  text: data.message,
                  icon: "success",
                });

                // Show the coupon discount field
                couponDiscountField.innerHTML = `-₹${data.couponDiscount}`;
                couponDiscountField.style.display = "block";

                // Update the total price
                finalTotalField.innerHTML = `₹${data.finalTotal}`;

                // Show remove button
                removeCouponBtn.style.display = "block";
              } else {
                Swal.fire({
                  title: "Error!",
                  text: data.message,
                  icon: "error",
                });
              }
            } catch (error) {
              console.error("Error applying coupon:", error);
            }
          });
        }

        if (removeCouponBtn) {
          removeCouponBtn.addEventListener("click", async () => {
            try {
              const response = await fetch("/remove-coupon", {
                method: "POST",
              });
              const data = await response.json();

              if (data.success) {
                Swal.fire({
                  title: "Removed!",
                  text: "Coupon has been removed.",
                  icon: "success",
                });

                // Hide the coupon discount field
                couponDiscountField.innerHTML = "";
                couponDiscountField.style.display = "none";

                // Reset total price
                finalTotalField.innerHTML = `₹${data.finalTotal}`;

                // Hide remove button
                removeCouponBtn.style.display = "none";
              } else {
                Swal.fire({
                  title: "Error!",
                  text: data.message,
                  icon: "error",
                });
              }
            } catch (error) {
              console.error("Error removing coupon:", error);
            }
          });
        }
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </body>
</html>
